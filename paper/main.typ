// Typst manuscript for this repository
#set text(lang: "ja")
#set heading(numbering: "1.")

= 超音波計測における安定タイミング検出のための自己教師あり表現学習とランキング最適化

著者: AI Playground プロジェクト  
日付: 2025-11-15

要旨  
ハイパーサーミア治療における温度測定では、患者の呼吸や体動により計測位置が変動し、測定誤差や作業時間の増加につながる。本研究では、超音波フレーム列から「安定したタイミング」を自動検出し、外部参照画像（息止め画像など）に近いフレームを検索するための自己教師あり表現学習とランキング最適化のパイプラインを提案する。具体的には、SimSiam による事前学習で頑健な埋め込みを獲得し、FastAP 損失でランキング品質を直接最適化する。また、DINO v2 + TripletLoss による代替パイプラインも試作した。`dataset.mat`（HDF5/MAT v7.3）からの遅延ロード、B-mode 変換、縦横比補正を行い、擬似ラベリングと Top-K 検索で評価する。実験では mAP 0.73 前後、Top-10 陽性率の向上、1 クエリあたり 0.146 秒の検索速度を確認した。一方で、長期学習時の埋め込み分散や外部クエリでの mAP 低下などの課題も観察された。

キーワード: 自己教師あり学習, 超音波, SimSiam, FastAP, 画像検索, ランキング学習, 擬似ラベル

== 背景と目的

- 背景: ハイパーサーミア治療での温度計測は、患者の呼吸・体動で患部位置が揺らぎ、適切な測定タイミングの判断が難しい。人手による監視は主観的で時間がかかり、測定精度・再現性に課題が残る。
- 目的: 超音波フレーム列から、安定区間（体動が小さいタイミング）を自動検出し、参照画像に類似するフレームを高速に抽出する。専門家アノテーションに依らず、擬似ラベルとランキング指標で性能を検証する。

== データと前処理

- 入力データ: `data/dataset.mat`（MAT v7.3/HDF5）。主要キーは `Acq/Amp`（または `Acq/Data`）。軸は `(frame, depth, lateral)` として解釈（`image_axes=(0,2,1)`）。
- 遅延ロード: HDF5 スライスによる遅延読み出しを想定（メモリ効率）。
- B-mode 変換: 振幅の絶対値→正規化→対数圧縮→ダイナミックレンジ [-60,0] dB の線形スケーリングで [0,1] に写像。
- 縦横比補正: `Acq/x` の深さ・ラテラル座標から実長比を推定し、縦方向のみリサンプリング。表示の上下は必要に応じて反転。

#figure(
  image("../docs/invivo_normalized.png", width: 80%),
  caption: [in vivo 参照画像の正規化例]
)

== 手法

=== SimSiam による自己教師あり事前学習

- バックボーン: ResNet（18/50 を利用）。強いデータ拡張から 2 ビューを生成し、片枝の勾配を停止して負のコサイン類似度を最小化。
- 目的: 擬似ラベルに依存せず、安定・不安定に頑健な表現を獲得。

=== FastAP によるランキング最適化

- 目的: 検索の平均適合率 (AP/mAP) を近似的に最大化。SimSiam 埋め込み上に小規模ヘッドを載せて微調整（バックボーンは原則凍結）。
- 期待効果: Top-K 検索の上位に陽性を集約し、レビュー効率と自動化精度を両立。

=== 代替パイプライン: DINO v2 + TripletLoss

- 実装: DINO v2 の特徴抽出器（`torch.hub`）を用い、MetricLearningNetwork と TripletLoss で埋め込みを学習（`trainer.py`）。
- 位置付け: SimSiam+FastAP と対比するベースライン的選択肢。

== 評価設計

- ペア類似度（擬似ラベル）: 自己相関が高い区間やセンサの安定区間から 0/1 ラベルを擬似生成。ROC/AUC、PR-AUC、F1/Accuracy を確認。
- 時系列区間評価: 類似度系列の平滑化と閾値で安定区間を抽出。IoU、区間 Precision/Recall、区間内分散で評価。
- 検索評価: コサイン類似度に基づく Top-K、mAP、Precision@K/Recall@K、クエリ時間。

== 実験設定

- データ: フレーム 445、擬似陽性 87（約 19.6%）。
- SimSiam: 10〜100 epoch、Batch 64〜128、CosineAnnealingLR、AMP 併用。
- FastAP: 10 epoch、AdamW、bins=100、sigma=0.05、バックボーン凍結（原則）。
- 代替: DINO v2 + TripletLoss を同データ上で試行。

== 結果

=== 主指標の比較（代表 2 ラン）

#table(
  columns: 4,
  [指標], [今回 (2025-11-05)], [前回 (2025-10-30)], [所見],
  [mAP], [0.7290], [0.7463], [わずかに低下],
  [Precision@1], [0.8022], [≈0.8000], [同等],
  [Precision@10], [0.7818], [≈0.7600], [微増],
  [Recall@10], [0.0291], [≈0.0250], [わずかに向上]
)

- 速度: invivo クエリ 1 件あたり 0.146 秒（約 3,050 fps）。
- 傾向: Precision@K は改善しつつ、mAP は外部クエリの一部で悪化。埋め込みの距離スケールや分散の変化が影響している可能性。

#figure(
  image("../docs/simsiam_fastap_top10.png", width: 90%),
  caption: [外部クエリに対する Top-10 フレーム例（参考可視化）]
)

== 考察

- 学習の長期化（100 epoch）は SimSiam 損失を改善した一方、外部クエリでの mAP 低下を招くケースがあった。埋め込み分布の縮退やスケール変化がランキングに影響した可能性。
- 擬似ラベルの質に依存する場面があり、ハードネガティブ（肋骨陰影や姿勢差）に対する誤検出が残る。Top-K の幅を広げたレビューや再注釈が有効。
- DINO v2 + Triplet も実用的なベースラインだが、ランキング最適化（FastAP）の直接効果は SimSiam 併用時に顕著。

== 今後の課題

- 外部クエリ近傍（Rank 1–10）フレームの再ラベルと可視化検証。
- SimSiam のオーグメント強度・プロジェクタ凍結条件の再検討、FastAP の sigma/bins チューニング。
- Top-20/50 の評価拡張と Recall 改善の監視。
- 埋め込み分布のドリフト監視（ヒストグラム比較、t-SNE/UMAP 可視化）。
- 遅延ロード前提の本番パイプライン化とログ/設定の標準化。

== 再現手順（要約）

1) データ配置  
`data/` に `dataset.mat` と `dataset_labels.csv`、任意で `invivo/invivo.jpg` を配置。

2) 前処理と可視化  
`docs/ultrasound_mat_preprocessing.md` の手順で B-mode 化と縦横比補正を確認。

3) 学習・評価（例）  
SimSiam→FastAP の実験用ノートブック `notebook/simsiam_fastap_ultrasound.ipynb` を実行し、mAP と Top-K を取得。代替として `main.py`（DINO v2 + Triplet）で学習可能。

== 結論

SimSiam による自己教師あり表現と FastAP によるランキング最適化の組み合わせは、超音波フレームの安定タイミング検出と参照画像に基づくフレーム検索に有望である。mAP 0.73 前後、Top-10 陽性率向上、実用的な推論速度を確認した。今後は外部クエリでの頑健性向上、擬似ラベル品質の改善、分布監視とチューニング自動化により、臨床現場での一貫した性能を目指す。

== 参考

- `docs/research.md`: 研究の目的と課題の整理  
- `docs/evaluation_approach.md`: 擬似ラベルと評価設計  
- `docs/ultrasound_mat_preprocessing.md`: 前処理の詳細  
- `docs/simsiam_fastap_seminar_summary.md`: 先行実験まとめ  
- `docs/simsiam_fastap_run_20251105_analysis.md`: 最新実験の詳細分析  
- `mat_ssl/README.md`, `mat_ssl/REPORT_JA.md`: 実装サマリー
