# Evaluation Approach

超音波ベースの温度測定で「安定したタイミング」を検知するために、学習モデルの評価を二段階で行う。専門家によるラベル付けが難しいことを前提に、取得しやすい指標や自動化可能な工夫を重視する。

## 1. ペア類似度評価（擬似ラベルベース）

### 目的
基準フレーム（例: 周期中で最も静止していると推定されるフレーム）と任意の測定フレームの類似度スコアから、安定タイミングかどうかを判断できるかを評価する。

### 擬似ラベル生成の例
- **呼吸周期の極小点を探す**: 同一動画内で振幅の変動が最も小さい区間を自動抽出し、その区間を「基準」候補とする。
- **複数フレーム同士の自己類似度**: サンプル間の自己相関（例: 連続するフレーム同士の類似度）を用い、自己類似度が高い区間を安定とみなす。
- **測定機器のセンサ値**: 温度上昇がなだらかで変動が少ないフレームを安定ラベルとして扱う（ラフ指標を利用）。

### 評価指標
- 擬似ラベルに対して ROC/AUC、PR-AUC を算出。
- 訓練/推論で使用する類似度しきい値を変えながら、F1 や Accuracy を確認。
- 擬似ラベルの質を確認するために、ランダムサンプルを肉眼チェックして逸脱が大きいものをフィードバックする（小規模な目視検証）。

## 2. 時系列セグメント評価

### 目的
動画全体から安定区間を探し出す能力を評価する。擬似ラベルを時間区間で作成し、類似度スコアの時系列から安定区間を推定する。

### 擬似ラベル生成の例
- 移動平均やポリゴンフィットなどで連続するフレームの類似度を平滑化し、一定の滑らかさと閾値で安定区間を自動抽出。
- 安定区間の開始/終了を、自己類似度系列の変化量が閾値以下になるタイミングとして定義。

### 評価指標
- 区間単位の Precision/Recall（検出した安定区間が擬似ラベルとどれだけ重なっているか）。
- 区間の Intersection over Union (IoU)。
- 安定区間内での類似度の分散、区間外とのコントラストなど統計的な指標。

## 3. 追加検討

- ペア類似度・区間検出ともに完全教師なしの評価となるので、定期的に少数のサンプルを選び manual チェックを行い、擬似ラベルが大きくズレていないかモニタリングする。
- 体動の強度を別指標で推定（たとえばフレーム差分の平均変位など）し、類似度スコアと組み合わせて閾値のチューニングに活かす。

```
python scripts/evaluate_similarity.py \
  --mat_glob "data/*.mat" \
  --method pairwise \
  --threshold 0.8 \
  --output eval_results.json
```

上記のような評価スクリプトを将来的に整備すれば、擬似ラベル生成→評価メトリクス算出→結果レポートまで自動化できる。
