# SimSiam + FastAP 実験レポート（2025-11-05 実行）

`result/20251105/fastap_report.md` をもとに、最新の FastAP 段階の挙動を整理しました。前回（2025-10-30）との比較も記載し、差分の要因を検討しています。

---

## 1. 実行サマリー

- 実行日時: 2025-11-03 07:24:40 (UTC)
- デバイス: CUDA
- チェックポイント: `/content/save/latest.pth`
- 埋め込み: `/content/save/inference_results/fastap_embeddings.npy`
- 指標ファイル: `/content/save/inference_results/fastap_metrics.json`
- Config（変更なし）:
  - backbone = ResNet-18 / projector_dim = 2048 / embedding_dim = 256
  - SimSiam: Epoch 100 / Batch 128 / LR 0.05 / CosineAnnealingLR
  - FastAP: Epoch 10 / Batch 64 / AdamW / bins=100 / sigma=0.05
  - Backbone freeze = True / Projector freeze = False / use_labels = False

---

## 2. 学習挙動

### 2.1 SimSiam 事前学習

- 100 エポックで最終損失 **-0.9326**（過去最高）まで改善。
- 収束速度: エポック 20 時点で -0.52、40 で -0.82、80 で -0.92 程度。後半も緩やかに改善。
- 1 エポック当たりの時間: 30〜34 秒（合計 3,180 秒 ≒ 53 分）。
- 前回（10 エポック）の最終損失 -0.8246 と比べて長期学習でさらに 0.1 以上低下。長期学習が安定収束に寄与。

### 2.2 FastAP 微調整

- 10 エポック実施。最良損失はエポック 9 の **-0.0302**（最終 -0.0291）。
- エポック 4 で一時的に損失が悪化（-0.0141）するが、その後回復し最後は再び改善。
- 総計 274 秒（約 4.6 分）。各エポック 26〜29 秒。

---

## 3. 評価指標

| 指標 | 今回 (2025-11-05) | 前回 (2025-10-30) | 備考 |
| --- | --- | --- | --- |
| mAP | **0.7290** | 0.7463 | わずかに低下（-0.0173） |
| Precision@1 | 0.8022 | 0.8000 (推定) | ほぼ同等 |
| Precision@5 | 0.7910 | 0.7800 (推定) | 微増 |
| Precision@10 | 0.7818 | 0.7600 (推定) | 微増 |
| Recall@10 | 0.0291 | 0.0250 (推定) | わずかに向上 |

> Precision/Recall@K の前回値は `result/20251030/report.md` 等からの読み替え。正確な JSON が未取得のため推定値を併記。

**所見**
- Precision@K は改善傾向だが、mAP が下がっていることから、全クエリのランキング品質にはばらつきが残っている。
- 高い precision に対して recall が依然として低く（Top-10 でも約 3%）、陽性が少ないデータ特性が影響している。

---

## 4. リトリーバル結果

### 4.1 内部クエリ（Index=0）

| Rank | Frame | Score | Label |
| ---- | ----- | ----- | ----- |
| 1 | 0 | 1.0000 | 1 |
| 2 | 2 | 0.9950 | 1 |
| 3 | 5 | 0.9941 | 1 |
| 4 | 11 | 0.9904 | 0 |
| 5 | 13 | 0.9864 | 0 |
| 6 | 135 | 0.9831 | 0 |
| 7 | 118 | 0.9788 | 0 |
| 8 | 16 | 0.9735 | 1 |
| 9 | 162 | 0.9733 | 1 |
| 10 | 23 | 0.9713 | 0 |

- Top-10 中、陽性は 5 件（Rank 1,2,3,8,9）。前回 Top-10 の陽性 4 件より改善。
- 類似度スコアが 0.97 以上と高く、上位枠と下位枠の差が小さい。

### 4.2 外部クエリ（invivo.jpg）

| Rank | Frame | Score | Label |
| ---- | ----- | ----- | ----- |
| 1 | 364 | 0.9970 | 0 |
| 2 | 363 | 0.9963 | 0 |
| 3 | 207 | 0.9955 | 0 |
| 4 | 365 | 0.9954 | 0 |
| 5 | 208 | 0.9946 | 0 |
| 6 | 367 | 0.9942 | 0 |
| 7 | 366 | 0.9938 | 0 |
| 8 | 202 | 0.9937 | 0 |
| 9 | 211 | 0.9930 | 0 |
| 10 | 205 | 0.9927 | 0 |

- Top-10 がすべてラベル 0。前回（2025-10-30）では陽性 4 件を含んでいたため、今回のモデルでは息止め参照へのマッチングが悪化した可能性がある。
- スコアが 0.99 以上に集中しており、embedding のスケーリングが変化した影響も考えられる（SimSiam 長期学習による分散縮小など）。

---

## 5. 差分分析

1. **SimSiam 学習の長期化**  
   - 損失は改善しているが、FastAP の mAP が低下している。埋め込みの「広がり」が不足し、外部クエリとの距離が詰まった結果、ラベル 0 が近くに密集した可能性。

2. **外部クエリの陽性消失**  
   - 新しいランキングでは Top-10 が全て陰性。前回との違いを確認するため、`frame_364` など該当フレームの可視化・再ラベルチェックが必要。

3. **Precision 向上 vs mAP 低下**  
   - Precision@10 は向上しているため、一部クエリでは性能が良くなっている。mAP の低下は特定のクエリ（特に外部クエリ）での悪化が影響している可能性。

---

## 6. 推奨アクション

1. **外部クエリ周辺のフレーム解析**  
   - Rank 1〜10（frame 202,205,207,208,211,363〜367）を可視化し、陽性判定との乖離を確認。必要に応じてラベリングやクエリの前処理を見直す。

2. **Embedding 分布の比較**  
   - SimSiam 10 epoch (2025-10-28) と 100 epoch (2025-11-05) での埋め込み分散や類似度ヒストグラムを比較し、長期学習が距離スケールに与える影響を評価する。

3. **FastAP チューニング**  
   - Projector を完全に凍結する実験や、シグマ／ビン数の変更を試し、ラベル 1 と 0 のクラス分離が崩れていないか検証。

4. **Top-K 評価の拡張**  
   - Recall が極端に低いので、Top-20 / 50 で陽性率がどう推移するか調べ、レビュー対象の K を再検討する。

5. **以前の重みとの比較評価**  
   - 2025-10-30 時点の checkpoint と今回の checkpoint を同条件（同じクエリセット）で評価し、改善／劣化したクエリを特定する。

---

## 7. 参考

- 原本レポート: `result/20251105/fastap_report.md`
- 既存パッケージ: `simsiam_fastap_package/`
- 先行比較レポート: `docs/simsiam_fastap_seminar_summary.md`

このレポートは実験ログを迅速に共有することを目的としており、さらなる分析結果が得られた際には追記してください。
