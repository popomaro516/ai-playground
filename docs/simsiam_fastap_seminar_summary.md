# SimSiam + FastAP セミナー発表メモ

このメモは、2025-10-30 実行の SimSiam → FastAP パイプラインによる invivo（息止め）画像検索の結果をゼミ向けに整理したものです。実験の流れ・主要指標・参考図表・今後の検討事項・用語集をまとめています。

---

## 1. 実験概要

- **目的**: 超音波フレーム群（`dataset.mat`）の中から、息止め参照画像（`invivo.jpg`）に似たフレームを高速・自動で抽出する。
- **データ構成**:
  - フレーム数 445
  - 擬似陽性ラベル 87（陽性比率 19.6%）
  - ラベルファイル: `data/dataset_labels.csv`
- **学習パイプライン**:
  1. **SimSiam**（ResNet-18）による自己教師あり事前学習（エポック 10、バッチ 128、学習率 0.05、AMP 有効）
  2. **FastAP** ヘッドによるファインチューニング（バッチ 64、AdamW、バックボーン凍結）
  3. 全 445 フレームの埋め込みを生成し、コサイン類似度で検索
- **実行環境メモ**: ノートブック（GPU 前提）ではフレームを一括ロードしており、遅延読み込みは行っていません。

---

## 2. ハイライト指標

| 指標 | 値 | 出典 |
| ---- | --- | --- |
| mAP（平均適合率） | **0.7463** | `result/20251030/metrics.json:2` |
| 検索対象フレーム数 | 445 | `result/20251030/metrics.json:3` |
| 擬似陽性枚数 | 87 | `result/20251030/metrics.json:4` |
| invivo クエリ 1 件あたりの検索時間 | **0.146 秒**（約 3,050 fps） | `result/20251030/topk_result.md:3` |
| Top-10 に含まれる陽性枚数 | 4 枚（全体比の約 2.0 倍） | `result/20251030/analytics_summary.json:5` |

---

## 3. 参照図表と読み取りポイント

- `result/20251030/figures/training_loss_curve.png`  
  − SimSiam 事前学習の損失が 10 エポックで **-0.82** まで単調に改善。安定収束を確認。

- `result/20251030/figures/label_distribution.png`  
  − 擬似陽性 19.6% / 陰性 80.4%。データが偏っているため高精度な Top-K 抽出が重要。

- `result/20251030/figures/topk_positive_ratio.png`  
  − Top-K（K=10）における陽性率が全体の約 2 倍に向上。検索結果が有用であることを示唆。

- `result/20251030/figures/topk_similarity_curve.png`  
  − Top-10 のコサイン類似度が 0.25〜0.28 に密集。しきい値より順位ベースで確認する運用が適切。

- `slide/20251105/assets/topk_grid.png`  
  − クエリ画像と Top-10 フレームのサムネイル比較。Rank 1・4・7・10 は息止め動作が近く、陰性ヒットは肋骨陰影などが誤検出要因になっている。

---

## 4. 所見と課題

- 陽性フレームを優先的に引けており、Top-K レビュー体制での活用が現実的。
- 類似度スコアの差が小さいため、順位の変動が起こりやすい。Top-10 以上をまとめて確認する方が堅実。
- 陰性ヒットの中には肋骨陰影や姿勢差といった「ハードネガティブ」が含まれる。再注釈や拡張データで精査する価値がある。

---

## 5. 次のアクション（推奨）

1. Rank 2〜6 の陰性フレームを中心に再ラベリングを検討し、誤差要因を洗い出す。
2. Top-20 / Top-50 まで範囲を広げ、陽性率がどこまで向上するか継続モニターする。
3. FastAP 側でプロジェクタ層も微調整する、あるいは強度の高いデータ拡張を試し、埋め込みの分離性向上を図る。
4. Marp スライドや Markdown レポートから PDF を自動出力するスクリプトを追加し、報告フローを自動化する。

---

## 6. 用語メモ（初心者向け）

- **SimSiam**  
  − 自己教師あり学習の一種。1 枚の画像から強いデータ拡張で 2 つのビュ―を作り、予測ベクトルとターゲットベクトルのコサイン類似度を最大化する。ネガティブサンプルを用いず、片方の枝の勾配を止める（Stop-Grad）ことで崩壊を防ぐ。

- **FastAP**  
  − 平均適合率（Average Precision）を滑らかに近似した損失関数。ランキングタスク向けで、類似度のソート結果が良くなるようネットワークを微調整する。

- **mAP（mean Average Precision）**  
  − 平均適合率。クエリごとの適合率を計算し、その平均を取った指標。1 に近いほど検索結果の質が高い。

- **コサイン類似度**  
  − ベクトル同士の角度に基づく類似度。1 に近いとほぼ同じ方向、0 だと直交、-1 だと真逆を意味する。

- **Top-K**  
  − 類似度順に並べたときの上位 K 件。ここでは K=10 が中心。Top-K の中に何件陽性が入っているかで実用性を評価している。

- **AMP（Automatic Mixed Precision）**  
  − 16bit/32bit を混ぜた計算で GPU メモリ使用量と速度を改善する PyTorch の機能。

- **ハードネガティブ**  
  − 見た目がクエリに似ているが実際は陰性であるサンプル。学習や評価を難しくするが、適切に扱うとモデル改善につながる。

- **Stop-Grad（勾配停止）**  
  − ネットワークの一部で勾配計算を止める操作。SimSiam ではターゲット側の出力を停止し、自己一致による崩壊を防いでいる。

---

### 参考資料

- スライド: `slide/20251105/simsiam_fastap_recap.md`
- 追加レポート: `result/20251030/report.md`
- トレーニングログ: `result/20251028/training_history.json`, `training_log.txt`

このメモをベースに、ゼミでは「手法・結果・課題・用語解説」の流れで紹介すると理解が進みやすくなります。
